{"version":3,"file":"resolveConflictBySelecting.test.js","sourceRoot":"/","sources":["lix-plugin/resolveConflictBySelecting.test.ts"],"names":[],"mappings":"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","sourcesContent":["// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-nocheck\n\nimport { test, expect } from \"vitest\";\nimport { newProject } from \"../project/newProject.js\";\nimport { loadProjectInMemory } from \"../project/loadProjectInMemory.js\";\nimport {\n\tisInSimulatedCurrentBranch,\n\tresolveConflictBySelecting,\n} from \"@lix-js/sdk\";\nimport { contentFromDatabase } from \"sqlite-wasm-kysely\";\n\ntest.skip(\"it should resolve a conflict with the selected change\", async () => {\n\tconst project = await loadProjectInMemory({ blob: await newProject() });\n\n\tconst dbFile = await project.lix.db\n\t\t.selectFrom(\"file\")\n\t\t.select(\"id\")\n\t\t.where(\"path\", \"=\", \"/db.sqlite\")\n\t\t.executeTakeFirstOrThrow();\n\n\tconst changes = await project.lix.db\n\t\t.insertInto(\"change\")\n\t\t.values([\n\t\t\t{\n\t\t\t\tid: \"e59b2fc6-612d-4087-9790-03b2ab724274\",\n\t\t\t\tauthor: \"Anonymous\",\n\t\t\t\tfile_id: dbFile.id,\n\t\t\t\tplugin_key: \"inlang-lix-plugin-v1\",\n\t\t\t\toperation: \"create\",\n\t\t\t\ttype: \"bundle\",\n\t\t\t\tvalue: {\n\t\t\t\t\tid: \"even_hour_mule_drum\",\n\t\t\t\t},\n\t\t\t\tcreated_at: \"2024-08-28 20:58:04\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"c0c9e3f3-0eba-4233-813f-e1901401a653\",\n\t\t\t\tauthor: \"Anonymous\",\n\t\t\t\tfile_id: dbFile.id,\n\t\t\t\tplugin_key: \"inlang-lix-plugin-v1\",\n\t\t\t\toperation: \"create\",\n\t\t\t\ttype: \"message\",\n\t\t\t\tvalue: {\n\t\t\t\t\tid: \"c2684c3d-3e14-47e4-96b7-8d33579bb7e9\",\n\t\t\t\t\tbundleId: \"even_hour_mule_drum\",\n\t\t\t\t\tlocale: \"en\",\n\t\t\t\t\tselectors: [],\n\t\t\t\t},\n\t\t\t\tcreated_at: \"2024-08-28 20:58:04\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"b92a634f-1e25-410f-af5a-e8702cc92ef0\",\n\t\t\t\tauthor: \"Anonymous\",\n\t\t\t\tfile_id: dbFile.id,\n\t\t\t\tplugin_key: \"inlang-lix-plugin-v1\",\n\t\t\t\toperation: \"create\",\n\t\t\t\ttype: \"variant\",\n\t\t\t\tvalue: {\n\t\t\t\t\tid: \"6a860f96-0cf3-477c-80ad-7893d8fde852\",\n\t\t\t\t\tmessageId: \"c2684c3d-3e14-47e4-96b7-8d33579bb7e9\",\n\t\t\t\t\tmatches: [],\n\t\t\t\t\tpattern: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\tvalue: \"My Awesome Todo App\",\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t\tcreated_at: \"2024-08-28 20:58:04\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"samuels-change\",\n\t\t\t\tauthor: \"Samuel\",\n\t\t\t\tparent_id: \"b92a634f-1e25-410f-af5a-e8702cc92ef0\",\n\t\t\t\tfile_id: dbFile.id,\n\t\t\t\tplugin_key: \"inlang-lix-plugin-v1\",\n\t\t\t\toperation: \"update\",\n\t\t\t\ttype: \"variant\",\n\t\t\t\tvalue: {\n\t\t\t\t\tid: \"6a860f96-0cf3-477c-80ad-7893d8fde852\",\n\t\t\t\t\tmessageId: \"c2684c3d-3e14-47e4-96b7-8d33579bb7e9\",\n\t\t\t\t\tmatches: [],\n\t\t\t\t\tpattern: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\tvalue: \"My awesome lix app\",\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t\tmeta: {\n\t\t\t\t\tid: \"6a860f96-0cf3-477c-80ad-7893d8fde852\",\n\t\t\t\t},\n\t\t\t\tcreated_at: \"2024-08-28 21:29:05\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tid: \"peters-change\",\n\t\t\t\tauthor: \"Peter\",\n\t\t\t\tparent_id: \"b92a634f-1e25-410f-af5a-e8702cc92ef0\",\n\t\t\t\tfile_id: dbFile.id,\n\t\t\t\tplugin_key: \"inlang-lix-plugin-v1\",\n\t\t\t\toperation: \"update\",\n\t\t\t\ttype: \"variant\",\n\t\t\t\tvalue: {\n\t\t\t\t\tid: \"6a860f96-0cf3-477c-80ad-7893d8fde852\",\n\t\t\t\t\tmessageId: \"c2684c3d-3e14-47e4-96b7-8d33579bb7e9\",\n\t\t\t\t\tmatches: [],\n\t\t\t\t\tpattern: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\t\tvalue: \"You are building an app\",\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t\tmeta: {\n\t\t\t\t\tid: \"6a860f96-0cf3-477c-80ad-7893d8fde852\",\n\t\t\t\t},\n\t\t\t\tcreated_at: \"2024-08-28 21:29:35\",\n\t\t\t},\n\t\t])\n\t\t.returningAll()\n\t\t.execute();\n\n\t// ---------------\n\t// Todo inlang sdk should auto write file to lix and differ must be\n\t// fault tolerant. without this code, the differ captures an old\n\t// change again\n\n\tfor (const change of changes) {\n\t\tawait project.db\n\t\t\t.insertInto(change.type as any)\n\t\t\t.values(change.value as any)\n\t\t\t.onConflict((c) => c.doNothing())\n\t\t\t.execute();\n\t}\n\tawait project.lix.db\n\t\t.updateTable(\"file\")\n\t\t.set({ data: contentFromDatabase(project._sqlite) })\n\t\t.where(\"path\", \"=\", \"/db.sqlite\")\n\t\t.execute();\n\t// ---------------\n\n\tconst conflicts = await project.lix.db\n\t\t.insertInto(\"conflict\")\n\t\t.values([\n\t\t\t{\n\t\t\t\tchange_id: \"samuels-change\",\n\t\t\t\tconflicting_change_id: \"peters-change\",\n\t\t\t\treason: \"\",\n\t\t\t},\n\t\t])\n\t\t.returningAll()\n\t\t.execute();\n\n\tconst changesInCurrentBranchBefore = await project.lix.db\n\t\t.selectFrom(\"change\")\n\t\t.selectAll()\n\t\t.where(isInSimulatedCurrentBranch)\n\t\t.execute();\n\n\texpect(changesInCurrentBranchBefore.map((c) => c.id)).toEqual([\n\t\tchanges[0]?.id,\n\t\tchanges[1]?.id,\n\t\tchanges[2]?.id,\n\t\t\"samuels-change\",\n\t]);\n\n\tawait resolveConflictBySelecting({\n\t\tlix: project.lix,\n\t\tconflict: conflicts[0]!,\n\t\tselectChangeId: \"peters-change\",\n\t});\n\n\tawait project.lix.settled();\n\n\tconst changesInCurrentBranch = await project.lix.db\n\t\t.selectFrom(\"change\")\n\t\t.selectAll()\n\t\t.where(isInSimulatedCurrentBranch)\n\t\t.execute();\n\n\texpect(changesInCurrentBranch.map((c) => c.id)).toEqual([\n\t\tchanges[0]?.id,\n\t\tchanges[1]?.id,\n\t\tchanges[2]?.id,\n\t\t\"peters-change\",\n\t]);\n});\n"]}