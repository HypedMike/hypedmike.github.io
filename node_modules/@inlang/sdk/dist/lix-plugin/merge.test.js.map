{"version":3,"file":"merge.test.js","sourceRoot":"/","sources":["lix-plugin/merge.test.ts"],"names":[],"mappings":"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","sourcesContent":["// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-nocheck\n\nimport { merge, type NewChange } from \"@lix-js/sdk\";\nimport { test, expect } from \"vitest\";\nimport { loadProjectInMemory } from \"../project/loadProjectInMemory.js\";\nimport { newProject } from \"../project/newProject.js\";\nimport { inlangLixPluginV1 } from \"./inlangLixPluginV1.js\";\nimport type { NewBundle, NewMessage, NewVariant } from \"../database/schema.js\";\n\ntest.skip(\"it should update the variant to the source's value\", async () => {\n\tconst target = await loadProjectInMemory({ blob: await newProject() });\n\tconst source = await loadProjectInMemory({ blob: await target.toBlob() });\n\n\tconst dbFile = await target.lix.db\n\t\t.selectFrom(\"file\")\n\t\t.select(\"id\")\n\t\t.where(\"path\", \"=\", \"/db.sqlite\")\n\t\t.executeTakeFirstOrThrow();\n\n\tconst commonChanges: NewChange[] = [\n\t\t{\n\t\t\tid: \"d92cdc2e-74cc-494c-8d51-958216272a17\",\n\t\t\tparent_id: undefined,\n\t\t\ttype: \"bundle\",\n\t\t\tfile_id: dbFile.id,\n\t\t\tplugin_key: inlangLixPluginV1[\"key\"],\n\t\t\toperation: \"create\",\n\t\t\tvalue: {\n\t\t\t\tid: \"even_hour_mule_drum\",\n\t\t\t} satisfies NewBundle,\n\t\t\tcommit_id: \"c8ad005b-a834-4ca3-84fb-9627546f2eba\",\n\t\t},\n\t\t{\n\t\t\tid: \"24f74fec-fc8a-4c68-b31c-d126417ce3af\",\n\t\t\tparent_id: undefined,\n\t\t\ttype: \"message\",\n\t\t\tfile_id: dbFile.id,\n\t\t\tplugin_key: inlangLixPluginV1[\"key\"],\n\t\t\toperation: \"create\",\n\t\t\tvalue: {\n\t\t\t\tid: \"c2684c3d-3e14-47e4-96b7-8d33579bb7e9\",\n\t\t\t\tbundleId: \"even_hour_mule_drum\",\n\t\t\t\tlocale: \"en\",\n\t\t\t\tselectors: [],\n\t\t\t} satisfies NewMessage,\n\t\t\tcommit_id: \"c8ad005b-a834-4ca3-84fb-9627546f2eba\",\n\t\t},\n\t\t{\n\t\t\tid: \"aaf0ec32-0c7f-4d07-af8c-922ce382aef1\",\n\t\t\tparent_id: undefined,\n\t\t\ttype: \"variant\",\n\t\t\tfile_id: dbFile.id,\n\t\t\tplugin_key: inlangLixPluginV1[\"key\"],\n\t\t\toperation: \"create\",\n\t\t\tvalue: {\n\t\t\t\tid: \"6a860f96-0cf3-477c-80ad-7893d8fde852\",\n\t\t\t\tmessageId: \"c2684c3d-3e14-47e4-96b7-8d33579bb7e9\",\n\t\t\t\tmatches: [],\n\t\t\t\tpattern: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\tvalue: \"My Awesome Todo App\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t} satisfies NewVariant,\n\t\t\tcommit_id: \"c8ad005b-a834-4ca3-84fb-9627546f2eba\",\n\t\t},\n\t];\n\n\tconst changesOnlyInTarget: NewChange[] = [];\n\tconst changesOnlyInSource: NewChange[] = [\n\t\t{\n\t\t\tid: \"01c059f9-8476-4aaa-aa6d-53ea3158b374\",\n\t\t\tparent_id: \"aaf0ec32-0c7f-4d07-af8c-922ce382aef1\",\n\t\t\ttype: \"variant\",\n\t\t\tfile_id: dbFile.id,\n\t\t\tplugin_key: inlangLixPluginV1[\"key\"],\n\t\t\toperation: \"update\",\n\t\t\tvalue: {\n\t\t\t\tid: \"6a860f96-0cf3-477c-80ad-7893d8fde852\",\n\t\t\t\tmessageId: \"c2684c3d-3e14-47e4-96b7-8d33579bb7e9\",\n\t\t\t\tmatches: [],\n\t\t\t\tpattern: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: \"text\",\n\t\t\t\t\t\tvalue: \"My app is buggy\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t} satisfies NewVariant,\n\t\t\tmeta: {\n\t\t\t\tid: \"6a860f96-0cf3-477c-80ad-7893d8fde852\",\n\t\t\t},\n\t\t\tcommit_id: \"df455c78-b5ed-4df0-9259-7bb694c9d755\",\n\t\t},\n\t];\n\n\tawait source.lix.db\n\t\t.insertInto(\"change\")\n\t\t.values([...commonChanges, ...changesOnlyInSource])\n\t\t.execute();\n\n\tawait target.lix.db\n\t\t.insertInto(\"change\")\n\t\t.values([...commonChanges, ...changesOnlyInTarget])\n\t\t.execute();\n\n\tawait merge({ sourceLix: source.lix, targetLix: target.lix });\n\n\tawait target.lix.settled();\n\n\t// need to reload project to re-initialize the state\n\tconst mergedProject = await loadProjectInMemory({\n\t\tblob: await target.toBlob(),\n\t});\n\n\tconst changes = await mergedProject.lix.db\n\t\t.selectFrom(\"change\")\n\t\t.selectAll()\n\t\t.execute();\n\n\texpect(changes).lengthOf(4);\n\n\tconst variant = await mergedProject.db\n\t\t.selectFrom(\"variant\")\n\t\t.selectAll()\n\t\t.where(\"id\", \"=\", \"6a860f96-0cf3-477c-80ad-7893d8fde852\")\n\t\t.executeTakeFirstOrThrow();\n\n\texpect(variant).toEqual(\n\t\texpect.objectContaining(changesOnlyInSource[0]?.value)\n\t);\n});\n"]}